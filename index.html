<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Gridee - The Word Grid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --sky-glow: 0 0 20px rgba(56, 189, 248, 0.4);
            --gold-glow: 0 0 25px rgba(251, 191, 36, 0.5);
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Lexend', sans-serif;
            touch-action: none;
            overscroll-behavior: none;
            user-select: none;
            background-color: #020617;
            color: #f8fafc;
            height: 100dvh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .grid-cell {
            aspect-ratio: 1 / 1;
            transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275), background-color 0.1s ease;
            border: 2px solid rgba(30, 41, 59, 0.3);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .letter-container {
            pointer-events: none;
            z-index: 5;
        }
        .cell-preview {
            opacity: 0.4;
            color: #38bdf8;
            transform: scale(0.9);
            background-color: rgba(56, 189, 248, 0.1);
        }
        .swiping-active {
            background-color: #38bdf8 !important;
            color: #020617 !important;
            transform: scale(0.95);
            box-shadow: var(--sky-glow);
            z-index: 10;
            border-color: #7dd3fc !important;
        }
        .gold-flash {
            animation: gold-burst 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards;
        }
        @keyframes gold-burst {
            0% { background-color: #fbbf24; transform: scale(1.1); box-shadow: var(--gold-glow); color: #451a03; }
            40% { background-color: #fcd34d; transform: scale(1.05); }
            100% { background-color: #1e293b; transform: scale(1); box-shadow: 0 0 0 transparent; }
        }
        .shake {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        .floating-point {
            position: absolute;
            pointer-events: none;
            font-weight: 600; /* Less bold (adjusted from 800) */
            z-index: 100;
            color: #fbbf24; 
            font-size: 1.4rem; 
            text-shadow: 0 2px 12px rgba(0, 0, 0, 1);
            animation: driftUp 1.44s ease-out forwards; /* 20% slower (adjusted from 1.2s) */
            white-space: nowrap;
        }
        @keyframes driftUp {
            0% { transform: translate(-50%, 0); opacity: 1; }
            100% { transform: translate(-50%, -80px); opacity: 0; }
        }

        .blue-scrollbar::-webkit-scrollbar { height: 3px; }
        .blue-scrollbar::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.4); border-radius: 10px; }
        .blue-scrollbar::-webkit-scrollbar-thumb { background: #0ea5e9; border-radius: 10px; }
        .blue-scrollbar { scrollbar-width: thin; scrollbar-color: #0ea5e9 rgba(30, 41, 59, 0.4); }

        .hud-glass {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .logo-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px;
            width: 24px;
            height: 24px;
        }
        .logo-cell { background: #1e293b; border-radius: 1px; }
        .logo-cell.active { background: #38bdf8; }

        .tally-animating {
            color: #fbbf24 !important;
            transform: scale(1.1);
            transition: transform 0.1s ease;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        #game-container {
            padding-bottom: env(safe-area-inset-bottom);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            min-height: 0; 
        }

        #game-grid {
            max-height: 42dvh; 
            aspect-ratio: 1 / 1;
            width: auto;
            margin: 0 auto;
        }
    </style>
</head>
<body class="flex flex-col items-center">

    <div id="splash-screen" class="fixed inset-0 bg-slate-950 z-[200] flex flex-col items-center p-4 text-center overflow-y-auto">
        <div class="m-auto flex flex-col items-center w-full max-sm py-8">
            <div class="relative mb-3">
                <div class="absolute -inset-4 bg-sky-500/20 blur-3xl rounded-full"></div>
                <div class="flex items-center gap-4 relative">
                    <div class="logo-grid scale-150 mr-4">
                        <div class="logo-cell"></div><div class="logo-cell active"></div><div class="logo-cell"></div><div class="logo-cell"></div>
                        <div class="logo-cell active"></div><div class="logo-cell active"></div><div class="logo-cell active"></div><div class="logo-cell active"></div>
                        <div class="logo-cell"></div><div class="logo-cell active"></div><div class="logo-cell"></div><div class="logo-cell"></div>
                        <div class="logo-cell"></div><div class="logo-cell active"></div><div class="logo-cell"></div><div class="logo-cell"></div>
                    </div>
                    <h1 class="text-6xl font-800 tracking-tighter text-white lowercase leading-none">gridee</h1>
                </div>
            </div>
            <p class="text-sky-500 text-[10px] mb-12 uppercase tracking-[0.4em] font-bold">The Daily Grid Challenge</p>
            <div class="w-full max-w-xs space-y-3 px-4">
                <button id="start-daily-btn" class="w-full py-4 bg-sky-500 hover:bg-sky-400 rounded-2xl font-800 text-slate-950 text-lg uppercase shadow-xl transition-all">Play Daily</button>
                <button id="start-practice-btn" class="w-full py-3.5 bg-slate-900 border-2 border-slate-800 text-slate-400 rounded-2xl font-800 text-xs uppercase tracking-widest transition-all">Practice Mode</button>
                <button id="how-to-btn" class="w-full py-3 bg-transparent text-slate-500 hover:text-sky-400 font-800 text-[9px] uppercase tracking-[0.3em] mt-2">How to Play</button>
            </div>
        </div>
    </div>

    <div id="how-to-overlay" class="fixed inset-0 bg-slate-950/95 backdrop-blur-xl z-[210] hidden flex-col items-center justify-center p-6 text-center">
        <div class="w-full max-w-sm flex flex-col items-center justify-center">
            <h2 class="text-4xl font-800 text-sky-400 tracking-tighter lowercase mb-10">Instructions</h2>
            <div class="space-y-6 text-left mb-10 w-full px-6 text-xs">
                <div class="flex gap-4 items-start">
                    <span class="w-8 h-8 shrink-0 bg-sky-500 rounded-lg flex items-center justify-center text-slate-950 font-800 text-sm">1</span>
                    <p class="text-slate-300 leading-relaxed font-semibold">Place letters one-by-one. Forming 4-letter words <span class="text-emerald-400">during placement</span> earns a massive <span class="text-emerald-400 font-bold">+10 Early Bird bonus each!</span></p>
                </div>
                <div class="flex gap-4 items-start">
                    <span class="w-8 h-8 shrink-0 bg-amber-500 rounded-lg flex items-center justify-center text-slate-950 font-800 text-sm">2</span>
                    <p class="text-slate-300 leading-relaxed font-semibold">Rearrange letters strategically. Each swap costs <span class="text-rose-400 font-bold">2 points</span>. Accuracy is everything.</p>
                </div>
                <div class="flex gap-4 items-start">
                    <span class="w-8 h-8 shrink-0 bg-emerald-500 rounded-lg flex items-center justify-center text-slate-950 font-800 text-sm">3</span>
                    <p class="text-slate-300 leading-relaxed font-semibold">Swipe in any direction to form words. 4 full rows OR columns scores <span class="text-amber-400 font-bold">+20</span>. Full grid (4 rows AND 4 columns) scores <span class="text-sky-400 font-bold">+100 - the Holy Grail!</span></p>
                </div>
            </div>
            <button id="close-how-to" class="px-12 py-4 bg-sky-500 text-slate-950 rounded-2xl font-800 uppercase tracking-widest text-xs active:scale-95 transition-all">Got it</button>
        </div>
    </div>

    <header class="w-full max-w-md flex justify-between items-center px-4 py-4 shrink-0 overflow-visible">
        <div class="flex items-center gap-1.5">
            <div class="logo-grid scale-90 mr-1">
                <div class="logo-cell"></div><div class="logo-cell active"></div><div class="logo-cell"></div><div class="logo-cell"></div>
                <div class="logo-cell active"></div><div class="logo-cell active"></div><div class="logo-cell active"></div><div class="logo-cell active"></div>
                <div class="logo-cell"></div><div class="logo-cell active"></div><div class="logo-cell"></div><div class="logo-cell"></div>
                <div class="logo-cell"></div><div class="logo-cell active"></div><div class="logo-cell"></div><div class="logo-cell"></div>
            </div>
            <h1 class="text-2xl font-800 tracking-tighter text-white leading-none">gridee</h1>
        </div>
        <div class="text-right">
            <div id="score-display" class="text-2xl font-800 text-white leading-none">0</div>
            <div class="text-[7px] font-extrabold text-slate-500 uppercase tracking-widest">Score</div>
        </div>
    </header>

    <main id="game-container" class="w-full max-w-md flex flex-col flex-1 opacity-0 transition-opacity duration-500 px-4 overflow-visible relative">
        <div class="flex justify-between gap-1 mb-2 shrink-0">
            <div id="step-1" class="h-0.5 flex-1 bg-sky-500 rounded-full transition-colors duration-500"></div>
            <div id="step-2" class="h-0.5 flex-1 bg-sky-500/20 rounded-full transition-colors duration-500"></div>
            <div id="step-3" class="h-0.5 flex-1 bg-sky-500/20 rounded-full transition-colors duration-500"></div>
        </div>

        <div id="hud-bar" class="flex items-center justify-between mb-3 hud-glass p-2.5 rounded-2xl shrink-0 h-16">
            <div class="flex items-center gap-2 flex-1 overflow-hidden pr-2">
                <span id="step-number" class="text-3xl font-800 text-orange-500 shrink-0">1.</span>
                <p id="top-msg" class="text-[14px] font-800 uppercase tracking-widest text-orange-500 leading-tight">PLACE ALL LETTERS</p>
            </div>
            
            <div id="right-hud-content" class="flex items-center gap-3">
                <div id="queue-box" class="flex items-center gap-3">
                    <div class="flex flex-col items-center">
                        <p class="text-[7px] font-800 text-slate-500 uppercase tracking-widest mb-0.5">Next</p>
                        <div class="flex gap-1" id="mini-queue"></div>
                    </div>
                    <div id="next-letter" class="w-11 h-11 bg-sky-500 rounded-xl flex items-center justify-center text-2xl font-800 text-slate-950 shadow-lg">?</div>
                </div>
                <div id="swap-counter" class="hidden flex flex-col items-end min-w-[50px]">
                    <span id="swap-penalty" class="text-2xl font-800 text-rose-400 leading-none">0</span>
                    <span class="text-[7px] font-bold text-slate-500 uppercase tracking-tighter">Penalty</span>
                </div>
            </div>
        </div>

        <div id="game-grid-container" class="relative group shrink-1 min-h-0 mb-1 overflow-visible">
            <div id="game-grid" class="grid grid-cols-4 gap-1 bg-slate-900/50 p-1 rounded-[1.25rem] border border-slate-800/50 backdrop-blur-sm"></div>
            <!-- Feedback Message with Black Container to mask background lines -->
            <div id="word-feedback" class="absolute -top-24 left-1/2 -translate-x-1/2 z-[60] bg-slate-950 px-6 py-2 rounded-2xl border border-slate-800 font-800 text-xl tracking-tighter text-center pointer-events-none opacity-0 transition-all duration-300 shadow-2xl whitespace-nowrap">COOL!</div>
        </div>

        <div class="w-full shrink-0 mb-2 mt-2">
            <button id="done-action-btn" class="w-full py-4 bg-emerald-500 text-slate-950 rounded-xl font-800 uppercase tracking-widest text-sm shadow-xl active:scale-95 transition-all opacity-30 cursor-not-allowed">
                PLACE LETTERS
            </button>
        </div>

        <div id="word-discovery" class="hidden shrink-0 flex flex-col mb-4 min-h-[40px]">
            <div class="flex justify-between items-center mb-1.5 px-1">
                <h3 class="text-slate-500 text-[9px] font-800 uppercase tracking-widest">Found Words</h3>
                <span id="word-count-badge" class="bg-sky-500/10 text-sky-500 text-[9px] px-2 py-0.5 rounded-full font-bold">0</span>
            </div>
            <div id="word-columns" class="flex flex-nowrap gap-1 overflow-x-auto blue-scrollbar pb-3 items-center"></div>
        </div>
    </main>

    <div id="result-modal" class="fixed inset-0 bg-slate-950/98 backdrop-blur-2xl hidden flex-col items-center justify-center p-4 z-[300]">
        <div class="w-full max-w-sm flex flex-col items-center text-center py-8 rounded-[2.5rem] hud-glass px-4">
            <h2 class="text-4xl font-800 text-sky-400 tracking-tighter lowercase leading-none">gridee</h2>
            <p id="result-game-num-display" class="text-[8px] text-slate-500 uppercase font-bold tracking-[0.4em] mb-4">Challenge #0</p>
            <div id="share-preview" class="grid grid-cols-4 gap-1 bg-slate-900/50 p-1 rounded-lg mb-6 w-24 h-24"></div>
            <div id="final-score" class="text-8xl font-800 tracking-tighter text-white leading-none">0</div>
            <span class="text-slate-500 uppercase tracking-[0.2em] text-[10px] font-800 mb-6">Total Score</span>
            <div class="w-full space-y-1.5 border-y border-slate-800 py-4 text-[10px] font-bold uppercase mb-6 text-left px-4">
                <div class="flex justify-between"><span>Words Found</span><span id="stat-word-count">0</span></div>
                <div class="flex justify-between text-emerald-400"><span>Placement Bonus</span><span id="stat-place-bonus">0</span></div>
                <div class="flex justify-between text-amber-400"><span>Line Bonus</span><span id="stat-line-bonus">0</span></div>
                <div class="flex justify-between text-rose-400"><span>Swap Penalty</span><span id="stat-deduction">0</span></div>
                <div id="grid-bonus-row" class="flex justify-between text-sky-400 hidden"><span>Grid Clear</span><span id="stat-grid-bonus">0</span></div>
            </div>
            <button id="share-btn" class="w-full py-4 bg-emerald-500 rounded-2xl font-800 text-slate-950 uppercase tracking-tighter text-lg mb-2 shadow-lg active:scale-95 transition-all">SHARE RESULTS</button>
            <button id="play-practice-again-btn" class="text-slate-600 text-[9px] font-800 uppercase underline mt-2">New Practice Game</button>
        </div>
    </div>

    <div id="toast" class="fixed top-10 left-1/2 -translate-x-1/2 bg-white text-slate-950 px-8 py-3 rounded-full font-800 shadow-2xl opacity-0 transition-all pointer-events-none z-[400] text-xs">Copied!</div>

    <script>
        const getGameNumber = () => {
            const epoch = new Date('2025-02-20').getTime();
            return Math.floor((new Date().getTime() - epoch) / (1000 * 60 * 60 * 24)) + 1;
        };

        const FUNNY_FINISHERS = [
            "GOOD TO GO", "LET'S COOK THIS SUCKER", "SCORE ME!", "THAT'S ENOUGH", 
            "BRING ON THE RESULTS", "COOKED TO PERFECTION", "I'M DONE DEEP FRYYING"
        ];

        const PHASES = { PLACE: 0, REARRANGE: 1, SWIPE: 2, RESULT: 3 };
        let currentPhase = PHASES.PLACE;
        let grid = Array(16).fill(null);
        let lettersToPlace = [];
        let placementIndex = 0;
        let penaltyPoints = 0;
        let wordScore = 0;
        let placeBonusScore = 0;
        let lineBonusScore = 0;
        let gridBonusScore = 0;
        let foundWords = [];
        let placementBonusLines = new Set();
        let placementDetectedWords = new Set();
        let swapStartIdx = null;
        let wordUsedCells = new Set();
        let isPracticeMode = false;
        let isSwiping = false;
        let currentSwipePath = [];
        let swipeWord = "";
        let hoveredCellIdx = null;
        let hudMessageVisible = true;

        let randomState;
        const seedRandom = (s) => randomState = s;
        const seededRandom = () => {
            randomState |= 0; randomState = randomState + 0x6D2B79F5 | 0;
            let t = Math.imul(randomState ^ randomState >>> 15, 1 | randomState);
            t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
            return ((t ^ t >>> 14) >>> 0) / 4294967296;
        };

        const DICTIONARY = new Set();
        const loadDictionary = async () => {
            try {
                const response = await fetch('https://raw.githubusercontent.com/dwyl/english-words/master/words_dictionary.json');
                const data = await response.json();
                Object.keys(data).forEach(word => { if (word.length >= 3 && word.length <= 10) DICTIONARY.add(word.toUpperCase()); });
            } catch (e) { ["THE","AND","YOU","ARE","FOR","GET","WAS","HAD","WIN","POP","GRID","BOLD","PLAY"].forEach(w => DICTIONARY.add(w)); }
        };

        const generateLetterSet = () => {
            const vWeights = { 'A': 9, 'E': 12, 'I': 9, 'O': 8, 'U': 4 };
            const cWeights = { 
                'R': 9, 'S': 9, 'T': 9, 'L': 8, 'N': 8, 'D': 7, 'G': 5, 'C': 5, 
                'M': 5, 'P': 5, 'H': 5, 'B': 4, 'F': 4, 'Y': 4, 'W': 3, 'K': 3, 
                'V': 2, 'X': 1, 'J': 1, 'Z': 1, 'Q': 1 
            };

            const vowelCount = seededRandom() > 0.5 ? 7 : 6;
            let letters = [];
            let counts = {};

            const pickLetter = (weightMap, currentCounts) => {
                let pool = [];
                for (let char in weightMap) {
                    let weight = weightMap[char];
                    let count = currentCounts[char] || 0;
                    if (count >= 2) continue; 
                    if (count === 1) weight = Math.max(1, Math.floor(weight * 0.3));
                    for (let i = 0; i < weight; i++) pool.push(char);
                }
                return pool[Math.floor(seededRandom() * pool.length)];
            };

            letters.push('E');
            counts['E'] = 1;

            while (letters.length < vowelCount) {
                let char = pickLetter(vWeights, counts);
                letters.push(char);
                counts[char] = (counts[char] || 0) + 1;
            }

            while (letters.length < 16) {
                let char = pickLetter(cWeights, counts);
                letters.push(char);
                counts[char] = (counts[char] || 0) + 1;
            }

            if (counts['Q'] > 0 && !counts['U']) {
                for(let i=0; i<letters.length; i++) {
                    if (vWeights[letters[i]] && letters[i] !== 'E') {
                        let old = letters[i];
                        counts[old]--;
                        letters[i] = 'U';
                        counts['U'] = 1;
                        break;
                    }
                }
            }

            for (let i = letters.length - 1; i > 0; i--) {
                const j = Math.floor(seededRandom() * (i + 1));
                [letters[i], letters[j]] = [letters[j], letters[i]];
            }

            const qIdx = letters.indexOf('Q');
            if (qIdx !== -1) {
                const uIdx = letters.indexOf('U');
                if (uIdx !== -1) {
                    letters.splice(uIdx, 1);
                    const newQIdx = letters.indexOf('Q');
                    if (newQIdx === 15) {
                        letters.splice(15, 1);
                        letters.splice(14, 0, 'Q', 'U');
                    } else {
                        letters.splice(newQIdx + 1, 0, 'U');
                    }
                }
            }

            return letters;
        };

        const updateUI = () => {
            const total = Math.max(0, wordScore + placeBonusScore + lineBonusScore + gridBonusScore - penaltyPoints);
            document.getElementById('score-display').innerText = total;
            
            const doneBtn = document.getElementById('done-action-btn');
            const topMsg = document.getElementById('top-msg');
            const stepNum = document.getElementById('step-number');
            const queueBox = document.getElementById('queue-box');
            const swapBox = document.getElementById('swap-counter');
            const swapVal = document.getElementById('swap-penalty');
            const s1 = document.getElementById('step-1'), s2 = document.getElementById('step-2'), s3 = document.getElementById('step-3');

            topMsg.style.opacity = hudMessageVisible ? "1" : "0";
            stepNum.style.opacity = hudMessageVisible ? "1" : "0";

            if (currentPhase === PHASES.PLACE) {
                topMsg.innerText = "PLACE ALL LETTERS";
                stepNum.innerText = "1.";
                s1.classList.add('bg-sky-500');
                queueBox.classList.remove('hidden');
                swapBox.classList.add('hidden');
                if (placementIndex < 16) {
                    doneBtn.innerText = "PLACE LETTERS";
                    doneBtn.classList.add('opacity-30', 'cursor-not-allowed');
                    doneBtn.disabled = true;
                } else {
                    doneBtn.innerText = "I'M DONE PLACING";
                    doneBtn.classList.remove('opacity-30', 'cursor-not-allowed');
                    doneBtn.disabled = false;
                }
            } else if (currentPhase === PHASES.REARRANGE) {
                topMsg.innerText = "REARRANGE ANY LETTERS";
                stepNum.innerText = "2.";
                s2.classList.replace('bg-sky-500/20', 'bg-sky-500');
                queueBox.classList.add('hidden');
                swapBox.classList.remove('hidden');
                swapVal.innerText = penaltyPoints > 0 ? `-${penaltyPoints}` : "0";
                doneBtn.innerText = "I'M DONE REARRANGING";
                doneBtn.classList.remove('opacity-30', 'cursor-not-allowed');
                doneBtn.disabled = false;
            } else if (currentPhase === PHASES.SWIPE) {
                topMsg.innerText = "BEGIN SWIPING WORDS";
                stepNum.innerText = "3.";
                s3.classList.replace('bg-sky-500/20', 'bg-sky-500');
                document.getElementById('word-discovery').classList.remove('hidden');
                queueBox.classList.add('hidden');
                swapBox.classList.add('hidden');
                if (foundWords.length > 0) {
                    if (doneBtn.innerText === "I'M DONE REARRANGING" || doneBtn.innerText === "BEGIN SWIPING") {
                       doneBtn.innerText = FUNNY_FINISHERS[Math.floor(Math.random() * FUNNY_FINISHERS.length)];
                    }
                } else {
                    doneBtn.innerText = "BEGIN SWIPING";
                }
            }
        };

        const createGrid = () => {
            const container = document.getElementById('game-grid');
            container.innerHTML = '';
            for (let i = 0; i < 16; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell bg-slate-800 rounded-2xl flex items-center justify-center text-3xl font-800 cursor-pointer select-none touch-none text-slate-100 shadow-inner';
                cell.id = `cell-${i}`;
                cell.dataset.index = i;
                cell.innerHTML = '<span class="letter-container"></span>';
                
                cell.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    handleInteraction(i, 'start');
                }, { passive: false });

                cell.addEventListener('mousedown', (e) => {
                    handleInteraction(i, 'start');
                });

                cell.addEventListener('mouseenter', () => {
                    handleInteraction(i, 'move');
                });

                container.appendChild(cell);
            }
            
            window.addEventListener('mouseup', () => handleInteraction(null, 'end'));
            window.addEventListener('touchend', () => handleInteraction(null, 'end'), { passive: false });
            
            container.addEventListener('touchmove', (e) => {
                e.preventDefault(); 
                const touch = e.touches[0];
                const el = document.elementFromPoint(touch.clientX, touch.clientY);
                if (el?.classList.contains('grid-cell') || el?.parentElement?.classList.contains('grid-cell')) {
                    const cellEl = el.classList.contains('grid-cell') ? el : el.parentElement;
                    const idx = parseInt(cellEl.dataset.index);
                    handleInteraction(idx, 'move');
                }
            }, { passive: false });
        };

        const checkPlacementBonus = (idx) => {
            const r = Math.floor(idx / 4), c = idx % 4;
            const rowIndices = [r*4, r*4+1, r*4+2, r*4+3];
            if (!rowIndices.some(i => grid[i] === null)) {
                const rowStr = rowIndices.map(i => grid[i]).join("");
                if (!placementBonusLines.has(`r${r}`) && DICTIONARY.has(rowStr)) {
                    placementBonusLines.add(`r${r}`);
                    rowIndices.forEach(i => placementDetectedWords.add(i));
                    placeBonusScore += 10;
                    showFloatingPoint("+10 BONUS");
                    showFeedback("PLACEMENT BONUS!", "text-emerald-400");
                }
            }
            const colIndices = [c, c+4, c+8, c+12];
            if (!colIndices.some(i => grid[i] === null)) {
                const colStr = colIndices.map(i => grid[i]).join("");
                if (!placementBonusLines.has(`c${c}`) && DICTIONARY.has(colStr)) {
                    placementBonusLines.add(`c${c}`);
                    colIndices.forEach(i => placementDetectedWords.add(i));
                    placeBonusScore += 10;
                    showFloatingPoint("+10 BONUS");
                    showFeedback("PLACEMENT BONUS!", "text-emerald-400");
                }
            }
            updateUI();
        };

        const renderGrid = () => {
            const next = lettersToPlace[placementIndex];
            grid.forEach((char, i) => {
                const cell = document.getElementById(`cell-${i}`);
                const letterEl = cell.querySelector('.letter-container');
                cell.classList.remove('bg-sky-500', 'text-slate-900', 'swiping-active', 'border-sky-400', 'cell-preview');
                if (char) { letterEl.innerText = char; }
                else if (currentPhase === PHASES.PLACE && hoveredCellIdx === i && next) {
                    letterEl.innerText = next; cell.classList.add('cell-preview');
                } else { letterEl.innerText = ''; }
                if (currentPhase === PHASES.SWIPE && currentSwipePath.includes(i)) cell.classList.add('swiping-active');
                if (currentPhase === PHASES.REARRANGE && swapStartIdx === i) cell.classList.add('bg-sky-500', 'text-slate-900', 'border-sky-400');
            });
        };

        const handleInteraction = (idx, type) => {
            if (currentPhase === PHASES.PLACE) {
                if (type === 'start' && idx !== null && !grid[idx]) {
                    grid[idx] = lettersToPlace[placementIndex++];
                    checkPlacementBonus(idx);
                    if (placementIndex === 16) currentPhase = PHASES.REARRANGE;
                    hoveredCellIdx = null; renderGrid(); updateUI(); updateQueue();
                } else if (type === 'move') { if(hoveredCellIdx !== idx) { hoveredCellIdx = idx; renderGrid(); } }
                else if (type === 'end') { hoveredCellIdx = null; renderGrid(); }
            } else if (currentPhase === PHASES.REARRANGE && type === 'start' && idx !== null) {
                if (swapStartIdx === null) swapStartIdx = idx;
                else if (swapStartIdx === idx) swapStartIdx = null;
                else {
                    const temp = grid[idx];
                    grid[idx] = grid[swapStartIdx];
                    grid[swapStartIdx] = temp;
                    penaltyPoints += 2; swapStartIdx = null;
                    showFloatingPoint("-2");
                    renderGrid(); updateUI();
                }
                renderGrid();
            } else if (currentPhase === PHASES.SWIPE) {
                if (type === 'start' && idx !== null) { isSwiping = true; currentSwipePath = [idx]; swipeWord = grid[idx]; renderGrid(); updateUI(); }
                else if (type === 'move' && isSwiping && idx !== null) {
                    if (idx === currentSwipePath[currentSwipePath.length - 2]) { currentSwipePath.pop(); swipeWord = swipeWord.slice(0, -1); renderGrid(); return; }
                    if (!currentSwipePath.includes(idx)) {
                        const last = currentSwipePath[currentSwipePath.length - 1];
                        const r1 = Math.floor(last/4), c1 = last%4, r2 = Math.floor(idx/4), c2 = idx%4;
                        if (Math.abs(r1-r2) <= 1 && Math.abs(c1-c2) <= 1) { currentSwipePath.push(idx); swipeWord += grid[idx]; renderGrid(); }
                    }
                } else if (type === 'end' && isSwiping) { validateWord(); isSwiping = false; currentSwipePath = []; swipeWord = ""; renderGrid(); }
            }
        };

        const validateWord = () => {
            if (swipeWord.length < 3 || foundWords.includes(swipeWord) || !DICTIONARY.has(swipeWord)) {
                if (swipeWord.length >= 3) document.getElementById('game-grid-container').classList.add('shake');
                setTimeout(() => document.getElementById('game-grid-container').classList.remove('shake'), 400);
                return;
            }
            foundWords.push(swipeWord);
            currentSwipePath.forEach(i => wordUsedCells.add(i));
            let pts = swipeWord.length === 3 ? 1 : swipeWord.length === 4 ? 2 : swipeWord.length === 5 ? 3 : 5;
            let finalPts = pts;
            if (swipeWord.length === 4) {
                const r = currentSwipePath.map(i => Math.floor(i/4)), c = currentSwipePath.map(i => i%4);
                if (r.every(v => v === r[0]) || c.every(v => v === c[0])) { 
                    lineBonusScore += 5; finalPts += 5;
                    showFeedback("+5 LINE!", "text-amber-400"); 
                }
            }
            wordScore += pts;
            showFloatingPoint(`+${finalPts}`);
            const div = document.createElement('div');
            div.className = 'word-item shrink-0 bg-slate-900 border border-slate-800 px-3 py-1.5 rounded-xl text-[10px] font-800 text-sky-400 uppercase flex items-center gap-2';
            div.innerHTML = `<span>${swipeWord}</span><span class="opacity-50 text-[8px]">${finalPts}</span>`;
            document.getElementById('word-columns').prepend(div);
            document.getElementById('word-count-badge').innerText = foundWords.length;
            updateUI();
        };

        const showFloatingPoint = (text) => {
            const container = document.getElementById('game-grid-container');
            const floating = document.createElement('div');
            floating.className = `floating-point`;
            floating.innerText = text;
            
            // Middle of Row 1 (center of the grid horizontally)
            floating.style.left = '50%';
            // Slightly above Row 1 (near the top of the container)
            floating.style.top = '10px';
            
            container.appendChild(floating);
            setTimeout(() => floating.remove(), 1440);
        };

        const showFeedback = (text, color) => {
            const el = document.getElementById('word-feedback');
            el.innerText = text; 
            // Lock background and container styles while changing text color class
            el.className = `absolute -top-24 left-1/2 -translate-x-1/2 z-[60] bg-slate-950 px-6 py-2 rounded-2xl border border-slate-800 font-800 text-xl tracking-tighter text-center pointer-events-none transition-all duration-300 shadow-2xl whitespace-nowrap ${color}`;
            el.style.opacity = "1"; setTimeout(() => el.style.opacity = "0", 1200);
        };

        const updateQueue = () => {
            const next = lettersToPlace[placementIndex];
            document.getElementById('next-letter').innerText = next || 'âœ“';
            const miniQueue = document.getElementById('mini-queue');
            miniQueue.innerHTML = '';
            for(let i = 3; i >= 1; i--) {
                const char = lettersToPlace[placementIndex + i];
                if (char) {
                    const d = document.createElement('div');
                    d.className = 'w-6 h-6 bg-slate-800 rounded border border-slate-700 flex items-center justify-center text-[10px] font-bold text-slate-400';
                    d.innerText = char; 
                    miniQueue.appendChild(d);
                }
            }
        };

        async function animateValue(id, start, end, duration) {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.add('tally-animating');
            const range = Math.abs(end - start);
            const step = Math.abs(Math.floor(duration / (Math.max(range, 1))));
            return new Promise(resolve => {
                let current = start;
                if (range === 0) { el.innerText = end; el.classList.remove('tally-animating'); resolve(); return; }
                const timer = setInterval(() => {
                    current += (end > start ? 1 : -1);
                    el.innerText = current;
                    if (current == end) { clearInterval(timer); el.classList.remove('tally-animating'); resolve(); }
                }, Math.max(step, 20));
            });
        }

        const showResults = async () => {
            currentPhase = PHASES.RESULT;
            document.getElementById('result-modal').classList.replace('hidden', 'flex');
            let rowsFull = 0, colsFull = 0;
            for(let i=0; i<4; i++) {
                const rowStr = grid.slice(i*4, i*4+4).join("");
                if (DICTIONARY.has(rowStr)) rowsFull++;
                const colIndices = [i, i+4, i+8, i+12];
                const colStr = colIndices.map(idx => grid[idx]).join("");
                if (DICTIONARY.has(colStr)) colsFull++;
            }
            if (rowsFull === 4 && colsFull === 4) gridBonusScore = 100;
            else if (rowsFull === 4 || colsFull === 4) gridBonusScore = 20;
            document.getElementById('grid-bonus-row').classList.toggle('hidden', gridBonusScore === 0);
            document.getElementById('result-game-num-display').innerText = isPracticeMode ? "Practice Mode" : `Challenge #${getGameNumber()}`;
            const sharePrev = document.getElementById('share-preview');
            sharePrev.innerHTML = '';
            for(let i=0; i<16; i++) {
                const d = document.createElement('div');
                d.className = `w-full h-full bg-slate-800 rounded border border-slate-700 flex items-center justify-center text-[8px] font-800 ${wordUsedCells.has(i) ? 'bg-sky-500 text-slate-900 border-sky-400' : ''}`;
                d.innerText = grid[i].toUpperCase(); sharePrev.appendChild(d);
            }
            await animateValue('stat-word-count', 0, foundWords.length, 500);
            await animateValue('stat-place-bonus', 0, placeBonusScore, 500);
            await animateValue('stat-line-bonus', 0, lineBonusScore, 500);
            await animateValue('stat-deduction', 0, -penaltyPoints, 400);
            if (gridBonusScore > 0) await animateValue('stat-grid-bonus', 0, gridBonusScore, 400);
            const total = Math.max(0, wordScore + placeBonusScore + lineBonusScore + gridBonusScore - penaltyPoints);
            await animateValue('final-score', 0, total, 1000);
        };

        const copyToClipboard = () => {
            const total = Math.max(0, wordScore + placeBonusScore + lineBonusScore + gridBonusScore - penaltyPoints);
            let gridVisual = "";
            for(let i=0; i<16; i++) {
                if (placementDetectedWords.has(i)) gridVisual += "ðŸŸ©";
                else if (wordUsedCells.has(i)) gridVisual += "ðŸŸ¦";
                else gridVisual += "â¬›";
                if ((i + 1) % 4 === 0) gridVisual += "\n";
                else gridVisual += " ";
            }
            const text = `gridee #${getGameNumber()}\nScore: ${total} | Swaps: -${penaltyPoints}\n\n${gridVisual}\nPlay at: https://planomy.github.io/gridee`;
            const el = document.createElement('textarea');
            el.value = text; document.body.appendChild(el); el.select();
            document.execCommand('copy'); document.body.removeChild(el);
            const toast = document.getElementById('toast');
            toast.style.opacity = '1'; setTimeout(() => toast.style.opacity = '0', 2000);
        };

        const startNewGame = (mode) => {
            isPracticeMode = mode === 'practice';
            grid = Array(16).fill(null); placementIndex = 0; penaltyPoints = 0; wordScore = 0; placeBonusScore = 0; lineBonusScore = 0; gridBonusScore = 0; foundWords = []; wordUsedCells.clear(); placementDetectedWords.clear(); placementBonusLines.clear();
            document.getElementById('splash-screen').style.display = 'none';
            document.getElementById('result-modal').classList.replace('flex', 'hidden');
            document.getElementById('game-container').classList.remove('opacity-0');
            document.getElementById('word-discovery').classList.add('hidden');
            document.getElementById('queue-box').classList.remove('hidden');
            document.getElementById('word-columns').innerHTML = '';
            currentPhase = PHASES.PLACE;
            seedRandom(isPracticeMode ? Math.floor(Math.random() * 1000000) : (new Date().getUTCFullYear()*10000 + (new Date().getUTCMonth()+1)*100 + new Date().getUTCDate()));
            lettersToPlace = generateLetterSet();
            createGrid(); renderGrid(); updateUI(); updateQueue();
        };

        window.onload = () => {
            document.getElementById('start-daily-btn').addEventListener('click', () => startNewGame('daily'));
            document.getElementById('start-practice-btn').addEventListener('click', () => startNewGame('practice'));
            document.getElementById('how-to-btn').addEventListener('click', () => document.getElementById('how-to-overlay').classList.replace('hidden', 'flex'));
            document.getElementById('close-how-to').addEventListener('click', () => document.getElementById('how-to-overlay').classList.replace('flex', 'hidden'));
            document.getElementById('done-action-btn').addEventListener('click', () => {
                if (currentPhase === PHASES.PLACE) { currentPhase = PHASES.REARRANGE; updateUI(); }
                else if (currentPhase === PHASES.REARRANGE) { currentPhase = PHASES.SWIPE; hudMessageVisible = true; updateUI(); }
                else if (currentPhase === PHASES.SWIPE) showResults();
                renderGrid();
            });
            document.getElementById('share-btn').addEventListener('click', copyToClipboard);
            document.getElementById('play-practice-again-btn').addEventListener('click', () => startNewGame('practice'));
            loadDictionary();
        };
    </script>
</body>
</html>
