<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Gridee - The Word Grid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --sky-glow: 0 0 20px rgba(56, 189, 248, 0.3);
            --gold-glow: 0 0 25px rgba(251, 191, 36, 0.4);
            --gold-metallic: linear-gradient(145deg, #fbbf24, #b45309);
            --pink-purple: linear-gradient(135deg, #a21caf, #6b21a8);
        }
        html, body {
            height: 100%; margin: 0; padding: 0; overflow: hidden;
            background-color: #020617;
        }
        body {
            font-family: 'Lexend', sans-serif; touch-action: none; overscroll-behavior: none; user-select: none;
            color: #f8fafc; height: 100dvh; width: 100vw;
            display: flex; flex-direction: column; align-items: center;
        }
        
        /* Layout Strategy - Tightened for larger grid */
        header { padding-top: max(8px, env(safe-area-inset-top)); margin-bottom: 4px; z-index: 50; }
        #game-container { margin-top: 0; padding-top: 0px; }

        /* Grid Styles */
        .grid-cell {
            aspect-ratio: 1 / 1; transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275), background-color 0.1s ease;
            border: 2px solid rgba(30, 41, 59, 0.3); position: relative; display: flex; align-items: center; justify-content: center;
        }
        .letter-container { pointer-events: none; z-index: 5; }
        .cell-preview { opacity: 0.4; color: #38bdf8; transform: scale(0.9); background-color: rgba(56, 189, 248, 0.1); }
        .swiping-active {
            background-color: #38bdf8 !important; color: #020617 !important; transform: scale(0.95);
            box-shadow: var(--sky-glow); z-index: 10; border-color: #7dd3fc !important;
        }
        
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        .floating-point {
            position: absolute; pointer-events: none; font-weight: 800; z-index: 100;
            color: #fbbf24; font-size: 1.6rem; text-shadow: 0 4px 12px rgba(0, 0, 0, 1);
            animation: driftUp 1.44s ease-out forwards; white-space: nowrap;
        }
        @keyframes driftUp { 0% { transform: translate(-50%, 0); opacity: 1; } 100% { transform: translate(-50%, -100px); opacity: 0; } }

        .tally-animating { color: #fbbf24 !important; transform: scale(1.1); transition: transform 0.1s ease; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Increased Grid Size by 20% (40dvh -> 48dvh) */
        #game-grid { max-height: 48dvh; aspect-ratio: 1 / 1; width: auto; margin: 0 auto; display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; padding: 4px; }

        .shout-chip { flex: 0 0 auto; padding: 8px 16px; border-radius: 20px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); font-size: 0.85rem; transition: all 0.2s ease; cursor: pointer; color: #f8fafc; white-space: nowrap; }
        .shout-chip.active { background: #38bdf8; color: #020617; border-color: #38bdf8; box-shadow: 0 0 10px rgba(56, 189, 248, 0.4); }
        
        .custom-shout-input { 
            background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; 
            padding: 12px 16px; color: #f8fafc; width: 100%; outline: none; font-family: 'Lexend', sans-serif; 
            margin-top: 12px; transition: border-color 0.2s;
        }
        .custom-shout-input:focus { border-color: #38bdf8; }
        .custom-shout-input::placeholder { color: rgba(255, 255, 255, 0.3); }

        .badge-slot { display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; width: 44px; height: 52px; }
        .badge-shield { position: absolute; width: 100%; height: 100%; background: var(--gold-metallic); clip-path: polygon(0% 0%, 100% 0%, 100% 70%, 50% 100%, 0% 70%); box-shadow: inset 0 2px 10px rgba(255,255,255,0.4); }
        .badge-icon-overlay { position: relative; z-index: 2; font-size: 1.2rem; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5)); margin-top: -8px; }
        .badge-slot.locked { filter: grayscale(1); opacity: 0.05; transform: scale(0.85); }
        .badge-slot.unlocked { 
            filter: grayscale(0); opacity: 1; 
            animation: premium-reveal 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        
        @keyframes premium-reveal {
            0% { transform: scale(0.8) rotate(-10deg); filter: brightness(2) drop-shadow(0 0 20px gold); }
            50% { transform: scale(1.2) rotate(5deg); }
            100% { transform: scale(1) rotate(0); filter: drop-shadow(0 0 12px rgba(251, 191, 36, 0.4)); }
        }

        .badge-counter { position: absolute; top: -2px; right: -8px; background: #38bdf8; color: #020617; font-size: 8px; font-weight: 900; padding: 1px 4px; border-radius: 6px; border: 1px solid #020617; z-index: 10; pointer-events: none; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        
        .timer-circle { transform: rotate(-90deg); filter: drop-shadow(0 0 12px rgba(56, 189, 248, 0.4)); }
        .timer-bg { fill: none; stroke: rgba(255, 255, 255, 0.05); stroke-width: 4; }
        .timer-progress { fill: none; stroke: #38bdf8; stroke-width: 4; stroke-linecap: round; transition: stroke-dashoffset 0.2s linear; }

        .results-overlay { background: #020617 !important; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        #time-up-overlay { position: absolute; inset: 0; background: rgba(2,6,23,0.92); backdrop-filter: blur(8px); z-index: 100; display: none; align-items: center; justify-content: center; border-radius: 1.5rem; }
        
        /* Lifted HUD Slightly higher (100px -> 80px) */
        #hud-bar { min-height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 2px; }

        .record-banner-active { 
            animation: spotlight-reveal 2.0s cubic-bezier(0.16, 1, 0.3, 1) forwards; 
        }
        @keyframes spotlight-reveal {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            10% { opacity: 1; transform: translate(-50%, -50%) scale(1.15); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1.15); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.2); pointer-events: none; }
        }
    </style>
</head>
<body class="flex flex-col items-center">

    <div id="splash-screen" class="fixed inset-0 bg-slate-950 z-[200] flex flex-col items-center p-4 text-center overflow-y-auto">
        <div class="m-auto flex flex-col items-center w-full max-sm py-8">
            <div class="relative mb-6">
                <div class="absolute -inset-10 bg-sky-500/20 blur-3xl rounded-full"></div>
                <div class="flex items-center gap-4 relative">
                    <!-- Logo: 4x4 grid with row 2 and col 2 highlighted -->
                    <svg width="48" height="48" viewBox="0 0 40 40" class="shrink-0 text-white/10">
                        <rect x="0" y="0" width="8" height="8" fill="currentColor" rx="1" />
                        <rect x="10" y="0" width="8" height="8" fill="#38bdf8" rx="1" />
                        <rect x="20" y="0" width="8" height="8" fill="currentColor" rx="1" />
                        <rect x="30" y="0" width="8" height="8" fill="currentColor" rx="1" />
                        <rect x="0" y="10" width="8" height="8" fill="#38bdf8" rx="1" />
                        <rect x="10" y="10" width="8" height="8" fill="#38bdf8" rx="1" />
                        <rect x="20" y="10" width="8" height="8" fill="#38bdf8" rx="1" />
                        <rect x="30" y="10" width="8" height="8" fill="#38bdf8" rx="1" />
                        <rect x="0" y="20" width="8" height="8" fill="currentColor" rx="1" />
                        <rect x="10" y="20" width="8" height="8" fill="#38bdf8" rx="1" />
                        <rect x="20" y="20" width="8" height="8" fill="currentColor" rx="1" />
                        <rect x="30" y="20" width="8" height="8" fill="currentColor" rx="1" />
                        <rect x="0" y="30" width="8" height="8" fill="currentColor" rx="1" />
                        <rect x="10" y="30" width="8" height="8" fill="#38bdf8" rx="1" />
                        <rect x="20" y="30" width="8" height="8" fill="currentColor" rx="1" />
                        <rect x="30" y="30" width="8" height="8" fill="currentColor" rx="1" />
                    </svg>
                    <h1 class="text-6xl font-800 tracking-tighter text-white lowercase leading-none">gridee</h1>
                </div>
            </div>
            <p class="text-sky-500 text-[10px] mb-12 uppercase tracking-[0.4em] font-bold">The Daily Grid Challenge</p>
            <div class="w-full max-w-xs space-y-3 px-4">
                <button id="start-daily-btn" class="w-full py-4 bg-sky-500 hover:bg-sky-400 rounded-2xl font-800 text-slate-950 text-lg uppercase shadow-xl transition-all">Play Daily</button>
                <button id="start-practice-btn" class="w-full py-3.5 bg-slate-900 border-2 border-slate-800 text-slate-400 rounded-2xl font-800 text-xs uppercase tracking-widest transition-all">Practice Mode</button>
                <button id="how-to-btn" class="w-full py-3 bg-transparent text-slate-500 hover:text-sky-400 font-800 text-[9px] uppercase tracking-[0.3em] mt-2">How to Play</button>
            </div>
        </div>
    </div>

    <!-- Instructions Overlay -->
    <div id="how-to-overlay" class="fixed inset-0 bg-slate-950/95 backdrop-blur-xl z-[210] hidden flex items-center justify-center p-6">
        <div class="w-full max-w-sm flex flex-col items-center text-center">
            <h2 class="text-4xl font-800 text-sky-400 tracking-tighter lowercase mb-10">Instructions</h2>
            <div class="space-y-6 text-left mb-10 w-full text-xs px-2">
                <div class="flex gap-4 items-start">
                    <span class="w-8 h-8 shrink-0 bg-sky-500 rounded-lg flex items-center justify-center text-slate-950 font-800 text-sm">1</span>
                    <p class="text-slate-300 leading-relaxed font-semibold">Place letters. Forming words during placement earns <span class="text-emerald-400 font-bold">+10 Early Bird bonus!</span></p>
                </div>
                <div class="flex gap-4 items-start">
                    <span class="w-8 h-8 shrink-0 bg-amber-500 rounded-lg flex items-center justify-center text-slate-950 font-800 text-sm">2</span>
                    <p class="text-slate-300 leading-relaxed font-semibold">Swap strategically. Each swap costs <span class="text-rose-400 font-bold">2 points</span>.</p>
                </div>
                <div class="flex gap-4 items-start">
                    <span class="w-8 h-8 shrink-0 bg-emerald-500 rounded-lg flex items-center justify-center text-slate-950 font-800 text-sm">3</span>
                    <p class="text-slate-300 leading-relaxed font-semibold">Swipe words in <span class="text-sky-400 font-bold">60 seconds</span>. Full grid clear scores <span class="text-sky-400 font-bold">+100!</span></p>
                </div>
            </div>
            <button id="close-how-to" class="px-12 py-4 bg-sky-500 text-slate-950 rounded-2xl font-800 uppercase tracking-widest text-xs active:scale-95 transition-all">Got it</button>
        </div>
    </div>

    <header class="w-full max-w-md flex justify-between items-center px-4 shrink-0 overflow-visible">
        <div class="flex items-center gap-1.5">
            <h1 class="text-2xl font-800 tracking-tighter text-white leading-none">gridee</h1>
            <div id="badge-bar-hud" class="flex gap-1 ml-1.5 opacity-80 h-3 cursor-pointer"></div>
        </div>
        <div class="text-right">
            <div id="score-display" class="text-2xl font-800 text-white leading-none">0</div>
            <div class="text-[7px] font-extrabold text-slate-500 uppercase tracking-widest">Score</div>
        </div>
    </header>

    <main id="game-container" class="w-full max-w-md flex flex-col flex-1 opacity-0 transition-opacity duration-500 px-4 overflow-visible relative">
        <div class="flex justify-between gap-1 mb-2 shrink-0 relative h-6 items-center">
            <div id="step-1-progress" class="h-1.5 flex-1 bg-sky-500/20 rounded-full overflow-hidden relative">
                <div id="progress-bar-fill" class="absolute inset-0 bg-sky-500 w-0 transition-all duration-300"></div>
            </div>
            <div id="word-feedback" class="absolute left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2 z-[60] bg-black border border-orange-500/30 px-3 py-0.5 rounded-full font-800 text-[10px] tracking-widest text-center pointer-events-none opacity-0 transition-all duration-300 whitespace-nowrap text-orange-500 shadow-2xl">COOL!</div>
        </div>

        <div id="hud-bar">
            <div id="right-hud-content" class="flex flex-col items-center gap-6 w-full">
                <div id="queue-box" class="flex flex-row items-center justify-center gap-4 transition-opacity duration-300">
                    <div class="flex gap-1.5" id="mini-queue"></div>
                    <div id="next-letter" class="w-16 h-16 bg-sky-500 rounded-2xl flex items-center justify-center text-4xl font-800 text-slate-950 shadow-[0_0_30px_rgba(56,189,248,0.3)]">?</div>
                </div>
                
                <div id="swap-counter" class="hidden flex flex-col items-center transition-opacity duration-300">
                    <span id="swap-penalty" class="text-3xl font-800 text-rose-400 leading-none">0</span>
                    <span class="text-[8px] font-bold text-slate-500 uppercase tracking-widest mt-1">Penalty</span>
                </div>

                <div id="circular-timer-box" class="hidden relative w-20 h-20 flex items-center justify-center">
                    <svg class="timer-circle" width="80" height="80">
                        <circle class="timer-bg" cx="40" cy="40" r="36"></circle>
                        <circle id="timer-progress" class="timer-progress" cx="40" cy="40" r="36"></circle>
                    </svg>
                    <span id="timer-text" class="absolute text-xl font-800 text-sky-400 tracking-tighter">60</span>
                </div>
            </div>
        </div>

        <div id="game-grid-container" class="relative group shrink-1 min-h-0 mb-1 overflow-visible">
            <div id="game-grid"></div>
            <div id="time-up-overlay">
                <button id="time-up-btn" class="bg-slate-950 border-2 border-sky-500/30 text-white font-800 px-10 py-5 rounded-3xl shadow-2xl scale-125 transition-transform uppercase tracking-tighter">TIME UP!</button>
            </div>
        </div>

        <!-- Slightly shorter Action Bar (py-5 -> py-4) -->
        <div class="w-full shrink-0 mb-1 mt-2">
            <button id="done-action-btn" style="background: var(--pink-purple);" class="w-full py-4 text-white rounded-2xl font-800 uppercase tracking-widest text-xs shadow-xl active:scale-95 transition-all opacity-0 pointer-events-none">
                SWAP LETTERS, CLICK WHEN DONE
            </button>
        </div>

        <div id="word-discovery" class="hidden shrink-0 flex flex-col mb-4 min-h-[50px]">
            <div class="flex justify-between items-center mb-1 px-1">
                <h3 class="text-slate-500 text-[9px] font-800 uppercase tracking-widest">Found Words</h3>
                <span id="word-count-badge" class="bg-sky-500/10 text-sky-500 text-[10px] px-2.5 py-0.5 rounded-full font-bold">0</span>
            </div>
            <div id="word-columns" class="flex flex-nowrap gap-1.5 overflow-x-auto no-scrollbar pb-3 items-center"></div>
        </div>
    </main>

    <!-- Results Modal - FIXED ALIGNMENT & MOBILE FIT -->
    <div id="result-modal" class="fixed inset-0 hidden flex-col items-center p-4 z-[300] results-overlay">
        <div class="w-full max-w-sm flex flex-col items-center text-center pt-6 pb-8 px-4 relative">
            
            <!-- Optimized Stats Row -->
            <div class="flex gap-6 mb-4 items-center justify-center w-full">
                <div class="flex flex-col items-center">
                    <span id="current-streak" class="text-5xl font-800 text-white leading-none">0</span>
                    <span class="text-[9px] text-slate-500 uppercase tracking-[0.3em] mt-1.5 font-800">Streak üî•</span>
                </div>
                <div class="h-10 w-[1px] bg-white/10"></div>
                <div class="flex flex-col items-center">
                    <span id="best-score" class="text-5xl font-800 text-white leading-none">0</span>
                    <span class="text-[9px] text-slate-500 uppercase tracking-[0.3em] mt-1.5 font-800">Best üèÜ</span>
                </div>
            </div>

            <!-- Trophy Room -->
            <div class="relative w-full mb-6">
                <div id="trophy-room" class="flex gap-3 bg-slate-900/40 p-4 px-5 rounded-2xl border border-white/5 items-end h-16 justify-center">
                    <div id="badge-architect" class="badge-slot locked" onclick="showBadgeInfo('architect')"><div class="badge-shield"></div><span class="badge-icon-overlay">üèÜ</span><span class="badge-counter hidden">0</span></div>
                    <div id="badge-century" class="badge-slot locked" onclick="showBadgeInfo('century')"><div class="badge-shield"></div><span class="badge-icon-overlay">üíØ</span><span class="badge-counter hidden">0</span></div>
                    <div id="badge-warp" class="badge-slot locked" onclick="showBadgeInfo('warp')"><div class="badge-shield"></div><span class="badge-icon-overlay">üöÄ</span><span class="badge-counter hidden">0</span></div>
                    <div id="badge-tactician" class="badge-slot locked" onclick="showBadgeInfo('tactician')"><div class="badge-shield"></div><span class="badge-icon-overlay">4Ô∏è‚É£</span><span class="badge-counter hidden">0</span></div>
                    <div id="badge-pure" class="badge-slot locked" onclick="showBadgeInfo('pure')"><div class="badge-shield"></div><span class="badge-icon-overlay">üö´</span><span class="badge-counter hidden">0</span></div>
                </div>
                <div id="new-record-badge" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-orange-500 text-slate-950 px-8 py-2 rounded-full font-800 text-sm shadow-2xl z-50 whitespace-nowrap scale-115 record-banner-active">NEW RECORD!</div>
            </div>
            
            <!-- Final Score Area -->
            <div class="flex flex-col items-center mb-4">
                <div id="final-score" class="text-8xl font-800 tracking-tighter text-white leading-none">0</div>
                <span class="text-slate-500 uppercase tracking-[0.4em] text-[10px] font-800 mt-2">Total Score</span>
            </div>
            
            <!-- Messaging Section -->
            <div class="w-full mb-6 text-left">
                <div id="shout-chips" class="flex gap-2 overflow-x-auto pb-2 no-scrollbar mb-3">
                    <button class="shout-chip active" onclick="updateShout(this, '')">None</button>
                    <button class="shout-chip" onclick="updateShout(this, 'Morning routine ‚úÖ')">Morning routine ‚úÖ</button>
                    <button class="shout-chip" onclick="updateShout(this, 'coffee soon? ‚òï')">coffee soon? ‚òï</button>
                    <button class="shout-chip" onclick="updateShout(this, 'Mind = Blown ü§Ø')">Mind = Blown ü§Ø</button>
                    <button class="shout-chip" onclick="updateShout(this, 'Calculated move. üìê')">Calculated move. üìê</button>
                    <button class="shout-chip" onclick="updateShout(this, 'Rematch? üëäüëä')">Rematch? üëäüëä</button>
                </div>
                <input type="text" id="shout-input" class="custom-shout-input text-xs" placeholder="Type a custom message..." maxlength="40" oninput="customShout(this.value)">
            </div>

            <!-- Action Buttons -->
            <button id="share-btn" style="background: var(--pink-purple);" class="w-full py-5 rounded-3xl font-800 text-white uppercase tracking-tighter text-xl mb-4 shadow-lg active:scale-95 transition-all">SHARE RESULTS</button>
            <button id="play-practice-again-btn" class="text-slate-600 text-[10px] font-800 uppercase underline tracking-widest">New Practice Game</button>
        </div>
    </div>

    <div id="toast" class="fixed top-10 left-1/2 -translate-x-1/2 bg-white text-slate-950 px-8 py-3 rounded-full font-800 shadow-2xl opacity-0 transition-all pointer-events-none z-[400] text-xs">Copied!</div>

    <script>
        // --- Utilities ---
        const getGameNumber = () => {
            const epoch = new Date('2025-02-20').getTime();
            return Math.floor((new Date().getTime() - epoch) / (1000 * 60 * 60 * 24)) + 1;
        };

        const STATS_KEY = "gridee_device_stats_v3";
        const TIME_UP_PHRASES = ["That's it amigo", "Whoah stop!", "That'll do", "Muchos gracias", "Stop, in the name of love"];
        const CORE_WORDS = ["MAKE", "BAND", "WORD", "PLAY", "GOLD", "GRID", "COOL", "LUCK", "BOLD", "PURE", "FAST", "TIME", "WINS", "GOOD", "DONE", "ROAD", "BIRD", "EARL", "BLUE", "FIRE"];
        
        let highScore = 0, streak = 0, lastPlayedDate = null;
        let badgesEarned = { century: 0, architect: 0, warp: 0, tactician: 0, pure: 0 };
        const PHASES = { PLACE: 0, REARRANGE: 1, SWIPE: 2, RESULT: 3 };
        let currentPhase = PHASES.PLACE, grid = Array(16).fill(null), lettersToPlace = [], placementIndex = 0;
        let penaltyPoints = 0, wordScore = 0, placeBonusScore = 0, lineBonusScore = 0, gridBonusScore = 0;
        let foundWords = [], placementBonusLines = new Set(), placementDetectedWords = new Set();
        let swapStartIdx = null, wordUsedCells = new Set(), isPracticeMode = false, isSwiping = false;
        let currentSwipePath = [], swipeWord = "", hoveredCellIdx = null;
        let activeShout = "", customShoutText = "";
        let swipeTimerInterval = null, swipeTimeRemaining = 60;

        const DICTIONARY = new Set(CORE_WORDS);
        async function loadDictionary() {
            try {
                const r = await fetch('https://raw.githubusercontent.com/dwyl/english-words/master/words_dictionary.json');
                const d = await r.json();
                Object.keys(d).forEach(w => { if (w.length >= 3 && w.length <= 10) DICTIONARY.add(w.toUpperCase()); });
            } catch (e) { console.warn("Dictionary fallback."); }
        }

        async function animateValue(id, start, end, duration) {
            const el = document.getElementById(id); if (!el) return;
            el.classList.add('tally-animating'); const range = Math.abs(end - start);
            return new Promise(resolve => {
                let current = start; if (range === 0) { el.innerText = end; el.classList.remove('tally-animating'); resolve(); return; }
                const timer = setInterval(() => {
                    current += (end > start ? 1 : -1); el.innerText = current;
                    if (current == end) { clearInterval(timer); el.classList.remove('tally-animating'); resolve(); }
                }, Math.max(Math.floor(duration / (range || 1)), 20));
            });
        }

        function loadStats() {
            const data = localStorage.getItem(STATS_KEY);
            if (data) {
                const p = JSON.parse(data);
                highScore = p.highScore || 0; streak = p.streak || 0; lastPlayedDate = p.lastPlayedDate || null;
                badgesEarned = p.badgesEarned || { century: 0, architect: 0, warp: 0, tactician: 0, pure: 0 };
            }
            document.getElementById('current-streak').innerText = streak;
            document.getElementById('best-score').innerText = highScore;
            renderBadges();
        }

        function saveStats(total, isDaily) {
            const today = new Date().toISOString().split('T')[0];
            if (isDaily) {
                if (lastPlayedDate !== today) { streak++; lastPlayedDate = today; }
                if (total > highScore) highScore = total;
            }
            localStorage.setItem(STATS_KEY, JSON.stringify({ highScore, streak, lastPlayedDate, badgesEarned }));
        }

        function generateLetterSet() {
            const seed = isPracticeMode ? Math.floor(Math.random() * 1000000) : (new Date().getUTCFullYear()*10000 + (new Date().getUTCMonth()+1)*100 + new Date().getUTCDate());
            seedRandom(seed);
            const vW = { 'A': 9, 'E': 12, 'I': 9, 'O': 8, 'U': 4 };
            const cW = { 'R': 9, 'S': 9, 'T': 9, 'L': 8, 'N': 8, 'D': 7, 'G': 5, 'C': 5, 'M': 5, 'P': 5, 'H': 5, 'B': 4, 'F': 4, 'Y': 4, 'W': 3, 'K': 3, 'V': 2, 'X': 1, 'J': 1, 'Z': 1, 'Q': 1 };
            let letters = []; let counts = {};
            const pick = (w, c) => {
                let pool = []; for (let char in w) { let wt = w[char]; if ((c[char] || 0) >= 2) continue; for (let i = 0; i < wt; i++) pool.push(char); }
                return pool[Math.floor(seededRandom() * pool.length)];
            };
            letters.push('E'); while (letters.length < 7) { let ch = pick(vW, counts); letters.push(ch); counts[ch] = (counts[ch] || 0) + 1; }
            while (letters.length < 16) { let ch = pick(cW, counts); letters.push(ch); counts[ch] = (counts[ch] || 0) + 1; }
            for (let i = letters.length - 1; i > 0; i--) { const j = Math.floor(seededRandom() * (i + 1)); [letters[i], letters[j]] = [letters[j], letters[i]]; }
            return letters;
        }

        function updateUI() {
            const total = Math.max(0, wordScore + placeBonusScore + lineBonusScore + gridBonusScore - penaltyPoints);
            document.getElementById('score-display').innerText = total;
            const btn = document.getElementById('done-action-btn');
            const progFill = document.getElementById('progress-bar-fill');
            progFill.style.width = `${(placementIndex / 16) * 100}%`;

            if (currentPhase === PHASES.PLACE) {
                btn.classList.add('opacity-0', 'pointer-events-none');
                document.getElementById('queue-box').classList.remove('hidden', 'opacity-0');
                document.getElementById('swap-counter').classList.add('hidden');
            } else if (currentPhase === PHASES.REARRANGE) {
                btn.classList.remove('opacity-0', 'pointer-events-none');
                btn.innerText = "SWAP LETTERS, CLICK WHEN DONE";
                document.getElementById('queue-box').classList.add('hidden', 'opacity-0');
                document.getElementById('swap-counter').classList.remove('hidden', 'opacity-0');
                document.getElementById('swap-penalty').innerText = penaltyPoints > 0 ? `-${penaltyPoints}` : "0";
            } else if (currentPhase === PHASES.SWIPE) {
                btn.innerText = "SWIPE WORDS - THE CLOCK IS TICKING!";
                document.getElementById('swap-counter').classList.add('hidden');
                document.getElementById('circular-timer-box').classList.remove('hidden');
                document.getElementById('word-discovery').classList.remove('hidden');
            }
        }

        function createGrid() {
            const container = document.getElementById('game-grid'); if (!container) return;
            container.innerHTML = '';
            for (let i = 0; i < 16; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell bg-slate-800 rounded-2xl flex items-center justify-center text-3xl font-800 cursor-pointer select-none touch-none text-slate-100 shadow-inner';
                cell.id = `cell-${i}`; cell.dataset.index = i; cell.innerHTML = '<span class="letter-container"></span>';
                cell.addEventListener('touchstart', (e) => { e.preventDefault(); handleInteraction(i, 'start'); }, { passive: false });
                cell.addEventListener('mousedown', (e) => handleInteraction(i, 'start'));
                cell.addEventListener('mouseenter', () => { if (isSwiping || currentPhase === PHASES.PLACE) handleInteraction(i, 'move'); });
                container.appendChild(cell);
            }
            window.addEventListener('mouseup', () => handleInteraction(null, 'end'));
            window.addEventListener('touchend', () => handleInteraction(null, 'end'));
            container.addEventListener('touchmove', (e) => {
                e.preventDefault(); const touch = e.touches[0];
                const el = document.elementFromPoint(touch.clientX, touch.clientY);
                if (el?.classList.contains('grid-cell') || el?.parentElement?.classList.contains('grid-cell')) {
                    const cellEl = el.classList.contains('grid-cell') ? el : el.parentElement;
                    handleInteraction(parseInt(cellEl.dataset.index), 'move');
                }
            }, { passive: false });
        }

        function handleInteraction(idx, type) {
            if (currentPhase === PHASES.PLACE) {
                if (type === 'start' && idx !== null && !grid[idx]) {
                    grid[idx] = lettersToPlace[placementIndex++]; checkPlacementBonus(idx);
                    if (placementIndex === 16) { 
                        setTimeout(() => { currentPhase = PHASES.REARRANGE; updateUI(); renderGrid(); }, 1500);
                    }
                    hoveredCellIdx = null; renderGrid(); updateUI(); updateQueue();
                } else if (type === 'move' && hoveredCellIdx !== idx) { hoveredCellIdx = idx; renderGrid(); }
                else if (type === 'end') { hoveredCellIdx = null; renderGrid(); }
            } else if (currentPhase === PHASES.REARRANGE && type === 'start' && idx !== null) {
                if (swapStartIdx === null) swapStartIdx = idx;
                else if (swapStartIdx === idx) swapStartIdx = null;
                else {
                    const temp = grid[idx]; grid[idx] = grid[swapStartIdx]; grid[swapStartIdx] = temp;
                    penaltyPoints += 2; swapStartIdx = null; showFloatingPoint("-2"); renderGrid(); updateUI();
                }
                renderGrid();
            } else if (currentPhase === PHASES.SWIPE) {
                if (type === 'start' && idx !== null) { isSwiping = true; currentSwipePath = [idx]; swipeWord = grid[idx]; renderGrid(); }
                else if (type === 'move' && isSwiping && idx !== null) {
                    if (idx === currentSwipePath[currentSwipePath.length - 2]) { currentSwipePath.pop(); swipeWord = swipeWord.slice(0, -1); renderGrid(); return; }
                    if (!currentSwipePath.includes(idx)) {
                        const last = currentSwipePath[currentSwipePath.length - 1];
                        const r1 = Math.floor(last/4), c1 = last%4, r2 = Math.floor(idx/4), c2 = idx%4;
                        if (Math.abs(r1-r2) <= 1 && Math.abs(c1-c2) <= 1) { currentSwipePath.push(idx); swipeWord += grid[idx]; renderGrid(); }
                    }
                } else if (type === 'end' && isSwiping) { validateWord(); isSwiping = false; currentSwipePath = []; swipeWord = ""; renderGrid(); }
            }
        }

        function validateWord() {
            if (swipeWord.length < 3 || foundWords.includes(swipeWord) || !DICTIONARY.has(swipeWord)) {
                if (swipeWord.length >= 3) {
                    const gc = document.getElementById('game-grid-container'); gc.classList.add('shake');
                    setTimeout(() => gc.classList.remove('shake'), 400);
                }
                return;
            }
            foundWords.push(swipeWord); currentSwipePath.forEach(i => wordUsedCells.add(i));
            let pts = swipeWord.length === 3 ? 1 : swipeWord.length === 4 ? 2 : swipeWord.length === 5 ? 3 : 5;
            let lineBonus = 0;
            if (swipeWord.length === 4) {
                const r = currentSwipePath.map(i => Math.floor(i/4)), c = currentSwipePath.map(i => i%4);
                if (r.every(v => v === r[0]) || c.every(v => v === c[0])) { lineBonus = 5; lineBonusScore += 5; }
            }
            wordScore += pts;
            showFloatingPoint(`+${pts + lineBonus}`);
            const div = document.createElement('div'); div.className = 'word-item shrink-0 bg-slate-900 border border-slate-800 px-3 py-1.5 rounded-xl text-[10px] font-800 text-sky-400 uppercase flex items-center gap-2';
            div.innerHTML = `<span>${swipeWord}</span><span class="opacity-50 text-[8px]">${pts + lineBonus}</span>`;
            document.getElementById('word-columns').prepend(div);
            document.getElementById('word-count-badge').innerText = foundWords.length;
            updateUI();
        }

        function checkPlacementBonus(idx) {
            const r = Math.floor(idx / 4), c = idx % 4;
            const rIdxs = [r*4, r*4+1, r*4+2, r*4+3];
            if (!rIdxs.some(i => grid[i] === null)) {
                const rS = rIdxs.map(i => grid[i]).join("");
                const rSRev = rS.split("").reverse().join("");
                if (!placementBonusLines.has(`r${r}`) && (DICTIONARY.has(rS) || DICTIONARY.has(rSRev))) {
                    placementBonusLines.add(`r${r}`); rIdxs.forEach(i => placementDetectedWords.add(i));
                    placeBonusScore += 10; showFloatingPoint("+10 EARLY BIRD");
                }
            }
            const cIdxs = [c, c+4, c+8, c+12];
            if (!cIdxs.some(i => grid[i] === null)) {
                const cS = cIdxs.map(i => grid[i]).join("");
                const cSRev = cS.split("").reverse().join("");
                if (!placementBonusLines.has(`c${c}`) && (DICTIONARY.has(cS) || DICTIONARY.has(cSRev))) {
                    placementBonusLines.add(`c${c}`); cIdxs.forEach(i => placementDetectedWords.add(i));
                    placeBonusScore += 10; showFloatingPoint("+10 EARLY BIRD");
                }
            }
            updateUI();
        }

        function renderGrid() {
            const next = lettersToPlace[placementIndex];
            grid.forEach((char, i) => {
                const cell = document.getElementById(`cell-${i}`); if (!cell) return;
                const letterEl = cell.querySelector('.letter-container');
                cell.classList.remove('bg-sky-500', 'text-slate-900', 'swiping-active', 'border-sky-400', 'cell-preview');
                if (char) { letterEl.innerText = char; }
                else if (currentPhase === PHASES.PLACE && hoveredCellIdx === i && next) { letterEl.innerText = next; cell.classList.add('cell-preview'); }
                else { letterEl.innerText = ''; }
                if (currentPhase === PHASES.SWIPE && currentSwipePath.includes(i)) cell.classList.add('swiping-active');
                if (currentPhase === PHASES.REARRANGE && swapStartIdx === i) cell.classList.add('bg-sky-500', 'text-slate-900', 'border-sky-400');
            });
        }

        function startSwipeTimer() {
            swipeTimeRemaining = 60; const progress = document.getElementById('timer-progress');
            const text = document.getElementById('timer-text'); 
            const circumference = 2 * Math.PI * 36;
            if (progress) { 
                progress.style.strokeDasharray = circumference; 
                progress.style.strokeDashoffset = 0; 
            }
            swipeTimerInterval = setInterval(() => {
                swipeTimeRemaining--; if (text) text.innerText = swipeTimeRemaining;
                if (progress) progress.style.strokeDashoffset = circumference - (swipeTimeRemaining / 60) * circumference;
                if (swipeTimeRemaining <= 0) { clearInterval(swipeTimerInterval); handleTimeUp(); }
            }, 1000);
        }

        function handleTimeUp() {
            const overlay = document.getElementById('time-up-overlay'); overlay.style.display = 'flex';
            const btn = document.getElementById('time-up-btn'); btn.innerText = TIME_UP_PHRASES[Math.floor(Math.random() * TIME_UP_PHRASES.length)];
            if (navigator.vibrate) navigator.vibrate(200);
            setTimeout(() => { showResults(); overlay.style.display = 'none'; }, 2000);
        }

        async function showResults() {
            currentPhase = PHASES.RESULT; 
            document.getElementById('result-modal').classList.replace('hidden', 'flex');
            
            let rF = 0, cF = 0;
            for(let i=0; i<4; i++) {
                const rS = grid.slice(i*4, i*4+4).join(""); if (DICTIONARY.has(rS)) rF++;
                const cS = [i, i+4, i+8, i+12].map(idx => grid[idx]).join(""); if (DICTIONARY.has(cS)) cF++;
            }
            const isFull = (rF === 4 && cF === 4);
            if (isFull) gridBonusScore = 100; else if (rF === 4 || cF === 4) gridBonusScore = 20;
            const total = Math.max(0, wordScore + placeBonusScore + lineBonusScore + gridBonusScore - penaltyPoints);
            
            const prevBest = JSON.parse(localStorage.getItem(STATS_KEY))?.highScore || 0;
            saveStats(total, !isPracticeMode);
            document.getElementById('current-streak').innerText = streak; document.getElementById('best-score').innerText = highScore;
            
            const banner = document.getElementById('new-record-badge');
            if (total > prevBest && !isPracticeMode) {
                banner.innerText = "NEW RECORD!";
                banner.classList.remove('hidden');
                await new Promise(resolve => setTimeout(resolve, 2000));
                banner.classList.add('hidden');
            }
            
            // Score tally FIRST
            await animateValue('final-score', 0, total, 1000);
            
            // Wait 0.5s for premium feel
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Trigger badge logic
            if (!isPracticeMode) {
                if (total >= 100) badgesEarned.century++;
                if (isFull) badgesEarned.architect++;
                if (foundWords.length >= 30) badgesEarned.warp++;
                if (rF === 4 || cF === 4) badgesEarned.tactician++;
                if (penaltyPoints === 0) badgesEarned.pure++;
                localStorage.setItem(STATS_KEY, JSON.stringify({ highScore, streak, lastPlayedDate, badgesEarned }));
            }
            renderBadges();
        }

        const copyToClipboard = () => {
            const total = Math.max(0, wordScore + placeBonusScore + lineBonusScore + gridBonusScore - penaltyPoints);
            let gridVisual = "";
            for(let i=0; i<16; i++) {
                if (placementDetectedWords.has(i)) gridVisual += "üü©"; else if (wordUsedCells.has(i)) gridVisual += "üü¶"; else gridVisual += "‚¨õ";
                if ((i + 1) % 4 === 0) gridVisual += "\n"; else gridVisual += " ";
            }
            const bKeys = ['architect', 'century', 'warp', 'tactician', 'pure'];
            const bM = { architect:'üèÜ', century:'üíØ', warp:'üöÄ', tactician:'4Ô∏è‚É£', pure:'üö´' };
            let bS = ""; bKeys.forEach(k => { if(badgesEarned[k] > 0) { bS += bM[k]; if (badgesEarned[k] > 1) bS += `^${badgesEarned[k]}`; } });
            
            const cS = [customShoutText, activeShout].filter(Boolean).join(" ");
            const sH = cS ? `${cS}\n\n` : "";
            const text = `${sH}gridee #${getGameNumber()}\nScore: ${total} | Streak: ${streak}üî•\n${bS ? 'Badges: ' + bS + '\n' : ''}${gridVisual}\nPlay: https://planomy.github.io/gridee`;
            
            const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select();
            document.execCommand('copy'); document.body.removeChild(el);
            const t = document.getElementById('toast'); t.style.opacity = '1'; setTimeout(() => t.style.opacity = '0', 2000);
        };

        function showBadgeInfo(key) {
            const info = BADGE_DESCRIPTIONS[key]; if (!info) return;
            document.getElementById('info-badge-icon').innerText = info.icon;
            document.getElementById('info-badge-title').innerText = info.title;
            document.getElementById('info-badge-desc').innerText = info.desc;
            document.getElementById('badge-info-modal').classList.remove('hidden');
        }
        function closeBadgeInfo() { document.getElementById('badge-info-modal').classList.add('hidden'); }

        function renderBadges() {
            const hudBar = document.getElementById('badge-bar-hud'); if (!hudBar) return;
            hudBar.innerHTML = '';
            const bData = [ { key:'architect', icon:'üèÜ' }, { key:'century', icon:'üíØ' }, { key:'warp', icon:'üöÄ' }, { key:'tactician', icon:'4Ô∏è‚É£' }, { key:'pure', icon:'üö´' } ];
            bData.forEach(b => {
                const count = badgesEarned[b.key];
                if (count > 0) {
                    const wrap = document.createElement('div'); 
                    wrap.className = 'w-3 h-3 bg-amber-400 rounded-full shadow-[0_0_8px_rgba(251,191,36,0.6)] animate-pulse'; 
                    hudBar.appendChild(wrap);
                }
                const slot = document.getElementById(`badge-${b.key}`); if (!slot) return;
                const counter = slot.querySelector('.badge-counter');
                if (count > 0) { 
                    slot.classList.replace('locked', 'unlocked'); 
                    counter.classList.remove('hidden'); 
                    counter.innerText = count; 
                } else { 
                    slot.classList.add('locked'); 
                    counter.classList.add('hidden'); 
                }
            });
        }

        function updateShout(btn, text) {
            document.querySelectorAll('.shout-chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active'); activeShout = text;
        }
        function customShout(val) { customShoutText = val.trim(); }

        const startNewGame = (mode) => {
            if (swipeTimerInterval) clearInterval(swipeTimerInterval);
            isPracticeMode = mode === 'practice'; grid = Array(16).fill(null); placementIndex = 0; penaltyPoints = 0; wordScore = 0; placeBonusScore = 0; lineBonusScore = 0; gridBonusScore = 0; foundWords = []; wordUsedCells.clear(); placementDetectedWords.clear(); placementBonusLines.clear();
            document.getElementById('splash-screen').style.display = 'none';
            document.getElementById('result-modal').classList.add('hidden');
            document.getElementById('game-container').classList.remove('opacity-0');
            document.getElementById('word-discovery').classList.add('hidden');
            document.getElementById('word-columns').innerHTML = '';
            document.getElementById('next-letter').classList.remove('hidden');
            document.getElementById('queue-box').classList.remove('hidden');
            document.getElementById('circular-timer-box').classList.add('hidden');
            document.getElementById('swap-counter').classList.add('hidden');
            document.getElementById('new-record-badge').classList.add('hidden');
            currentPhase = PHASES.PLACE; lettersToPlace = generateLetterSet(); createGrid(); renderGrid(); updateUI(); updateQueue(); renderBadges();
        };

        function showFloatingPoint(text) {
            const c = document.getElementById('game-grid-container'); const f = document.createElement('div'); f.className = `floating-point`; f.innerText = text;
            f.style.left = '50%'; f.style.top = '10px'; c.appendChild(f); setTimeout(() => f.remove(), 1440);
        }
        function updateQueue() {
            const next = lettersToPlace[placementIndex]; 
            const nL = document.getElementById('next-letter');
            if (next) { nL.innerText = next; nL.classList.remove('hidden'); } else { nL.classList.add('hidden'); }
            const mQ = document.getElementById('mini-queue'); mQ.innerHTML = '';
            for(let i = 5; i >= 1; i--) {
                const ch = lettersToPlace[placementIndex + i]; if (ch) { const d = document.createElement('div'); d.className = 'w-6 h-6 bg-slate-800 rounded border border-slate-700 flex items-center justify-center text-[10px] font-bold text-slate-400'; d.innerText = ch; mQ.appendChild(d); }
            }
        }

        window.onload = () => {
            loadStats();
            document.getElementById('start-daily-btn').addEventListener('click', () => startNewGame('daily'));
            document.getElementById('start-practice-btn').addEventListener('click', () => startNewGame('practice'));
            document.getElementById('how-to-btn').addEventListener('click', () => document.getElementById('how-to-overlay').classList.remove('hidden'));
            document.getElementById('close-how-to').addEventListener('click', () => document.getElementById('how-to-overlay').classList.add('hidden'));
            document.getElementById('done-action-btn').addEventListener('click', () => {
                if (currentPhase === PHASES.REARRANGE) { currentPhase = PHASES.SWIPE; updateUI(); startSwipeTimer(); }
                renderGrid();
            });
            document.getElementById('share-btn').addEventListener('click', copyToClipboard);
            document.getElementById('play-practice-again-btn').addEventListener('click', () => startNewGame('practice'));
            window.showBadgeInfo = showBadgeInfo; window.closeBadgeInfo = closeBadgeInfo; window.updateShout = updateShout; window.customShout = customShout;
            loadDictionary();
        };

        const BADGE_DESCRIPTIONS = {
            architect: { title: "Holy Grail", icon: "üèÜ", desc: "Clear all 4 rows AND all 4 columns." },
            century: { title: "Century Club", icon: "üíØ", desc: "Cross the 100 point milestone." },
            warp: { title: "Warp Speed", icon: "üöÄ", desc: "Found 30 or more words in 1 minute." },
            tactician: { title: "Line Master", icon: "4Ô∏è‚É£", desc: "Cleared 4 rows or columns." },
            pure: { title: "Pure Play", icon: "üö´", desc: "Finished with 0 Swaps." }
        };

        let randomState;
        function seedRandom(s) { randomState = s; }
        function seededRandom() {
            randomState |= 0; randomState = randomState + 0x6D2B79F5 | 0;
            let t = Math.imul(randomState ^ randomState >>> 15, 1 | randomState);
            t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
            return ((t ^ t >>> 14) >>> 0) / 4294967296;
        };
    </script>
</body>
</html>
